---
import { SITE_LANG } from '../lib/client';

const repo = import.meta.env.PUBLIC_GISCUS_REPO;
const repoId = import.meta.env.PUBLIC_GISCUS_REPO_ID;
const category = import.meta.env.PUBLIC_GISCUS_CATEGORY || '';
const categoryId = import.meta.env.PUBLIC_GISCUS_CATEGORY_ID;
---

<section class="border-t border-slate-200 pt-10 dark:border-slate-800" id="comments">
  <div
    class="giscus"
    data-repo={repo}
    data-repo-id={repoId}
    data-category={category}
    data-category-id={categoryId}
    data-lang={SITE_LANG}
  ></div>
</section>

<script is:inline>
  // Giscus loader â€” reads config from .giscus container's data attributes.
  // Uses astro:page-load so it re-initialises after every View Transition navigation.
  if (!window.__giscusInit) {
    window.__giscusInit = true;

    function loadGiscus() {
      var container = document.querySelector('.giscus[data-repo]');
      if (!container || container.querySelector('iframe')) return;

      var s = document.createElement('script');
      s.src = 'https://giscus.app/client.js';
      s.setAttribute('data-repo', container.getAttribute('data-repo'));
      s.setAttribute('data-repo-id', container.getAttribute('data-repo-id'));
      s.setAttribute('data-category', container.getAttribute('data-category'));
      s.setAttribute('data-category-id', container.getAttribute('data-category-id'));
      s.setAttribute('data-mapping', 'pathname');
      s.setAttribute('data-strict', '0');
      s.setAttribute('data-reactions-enabled', '1');
      s.setAttribute('data-emit-metadata', '0');
      s.setAttribute('data-input-position', 'top');
      s.setAttribute('data-theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
      s.setAttribute('data-lang', container.getAttribute('data-lang'));
      s.crossOrigin = 'anonymous';
      s.async = true;
      container.appendChild(s);
    }

    function getGiscusTheme() {
      return document.documentElement.classList.contains('dark') ? 'dark' : 'light';
    }

    function setGiscusTheme(theme) {
      var iframe = document.querySelector('iframe.giscus-frame');
      if (!iframe) return;
      iframe.contentWindow.postMessage(
        { giscus: { setConfig: { theme: theme } } },
        'https://giscus.app'
      );
    }

    // Watch for dark mode class changes on <html>
    new MutationObserver(function () {
      setGiscusTheme(getGiscusTheme());
    }).observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['class'],
    });

    // Sync theme whenever a Giscus iframe becomes ready
    window.addEventListener('message', function (event) {
      if (event.origin !== 'https://giscus.app') return;
      if (!(typeof event.data === 'object' && event.data.giscus)) return;
      setGiscusTheme(getGiscusTheme());
    });

    // Load on every page (initial + View Transition navigations)
    document.addEventListener('astro:page-load', loadGiscus);
  }
</script>
