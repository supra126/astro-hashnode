---
import { SITE_LANG } from '../lib/client';

const repo = import.meta.env.PUBLIC_GISCUS_REPO;
const repoId = import.meta.env.PUBLIC_GISCUS_REPO_ID;
const category = import.meta.env.PUBLIC_GISCUS_CATEGORY || '';
const categoryId = import.meta.env.PUBLIC_GISCUS_CATEGORY_ID;
---

<section class="border-t border-slate-200 pt-10 dark:border-slate-800" id="comments">
  <div class="giscus"></div>
  <script
    is:inline
    src="https://giscus.app/client.js"
    data-repo={repo}
    data-repo-id={repoId}
    data-category={category}
    data-category-id={categoryId}
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="top"
    data-theme="light"
    data-lang={SITE_LANG}
    crossorigin="anonymous"
    async
  ></script>
</section>

<script is:inline>
  // Guard: only set up global observers once (they survive View Transition navigations)
  if (!window.__giscusObserversSet) {
  window.__giscusObserversSet = true;

  (function () {
    function getGiscusTheme() {
      return document.documentElement.classList.contains('dark') ? 'dark' : 'light';
    }

    function setGiscusTheme(theme) {
      var iframe = document.querySelector('iframe.giscus-frame');
      if (!iframe) return;
      iframe.contentWindow.postMessage(
        { giscus: { setConfig: { theme: theme } } },
        'https://giscus.app'
      );
    }

    // Watch for dark mode class changes on <html>
    new MutationObserver(function () {
      setGiscusTheme(getGiscusTheme());
    }).observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['class'],
    });

    // Sync theme whenever a Giscus iframe becomes ready (works for new iframes after VT navigation)
    window.addEventListener('message', function (event) {
      if (event.origin !== 'https://giscus.app') return;
      if (!(typeof event.data === 'object' && event.data.giscus)) return;
      setGiscusTheme(getGiscusTheme());
    });
  })();

  } // end observer guard
</script>
