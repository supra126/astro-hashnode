---
import { SITE_LANG } from '../lib/client';

const repo = import.meta.env.PUBLIC_GISCUS_REPO;
const repoId = import.meta.env.PUBLIC_GISCUS_REPO_ID;
const category = import.meta.env.PUBLIC_GISCUS_CATEGORY || '';
const categoryId = import.meta.env.PUBLIC_GISCUS_CATEGORY_ID;
---

<section class="border-t border-slate-200 pt-10 dark:border-slate-800" id="comments">
  <div class="giscus"></div>
</section>

<script
  is:inline
  data-giscus-repo={repo}
  data-giscus-repo-id={repoId}
  data-giscus-category={category}
  data-giscus-category-id={categoryId}
  data-giscus-lang={SITE_LANG}
>
  // Load Giscus into the .giscus container.
  // Works on initial page load AND after View Transition (SPA) navigations.
  function loadGiscus() {
    var container = document.querySelector('.giscus');
    if (!container || container.querySelector('iframe')) return;

    var self = document.currentScript || document.querySelector('script[data-giscus-repo]');
    var s = document.createElement('script');
    s.src = 'https://giscus.app/client.js';
    s.setAttribute('data-repo', self.getAttribute('data-giscus-repo'));
    s.setAttribute('data-repo-id', self.getAttribute('data-giscus-repo-id'));
    s.setAttribute('data-category', self.getAttribute('data-giscus-category'));
    s.setAttribute('data-category-id', self.getAttribute('data-giscus-category-id'));
    s.setAttribute('data-mapping', 'pathname');
    s.setAttribute('data-strict', '0');
    s.setAttribute('data-reactions-enabled', '1');
    s.setAttribute('data-emit-metadata', '0');
    s.setAttribute('data-input-position', 'top');
    s.setAttribute('data-theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
    s.setAttribute('data-lang', self.getAttribute('data-giscus-lang'));
    s.crossOrigin = 'anonymous';
    s.async = true;
    container.appendChild(s);
  }

  loadGiscus();
</script>

<script is:inline>
  // Guard: only set up global observers once (they survive View Transition navigations)
  if (!window.__giscusObserversSet) {
  window.__giscusObserversSet = true;

  (function () {
    function getGiscusTheme() {
      return document.documentElement.classList.contains('dark') ? 'dark' : 'light';
    }

    function setGiscusTheme(theme) {
      var iframe = document.querySelector('iframe.giscus-frame');
      if (!iframe) return;
      iframe.contentWindow.postMessage(
        { giscus: { setConfig: { theme: theme } } },
        'https://giscus.app'
      );
    }

    // Watch for dark mode class changes on <html>
    new MutationObserver(function () {
      setGiscusTheme(getGiscusTheme());
    }).observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['class'],
    });

    // Sync theme whenever a Giscus iframe becomes ready (works for new iframes after VT navigation)
    window.addEventListener('message', function (event) {
      if (event.origin !== 'https://giscus.app') return;
      if (!(typeof event.data === 'object' && event.data.giscus)) return;
      setGiscusTheme(getGiscusTheme());
    });
  })();

  } // end observer guard
</script>
