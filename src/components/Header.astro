---
import Container from './Container.astro';
import PublicationLogo from './PublicationLogo.astro';
import type { Publication } from '../types';

interface Props {
  publication: Publication;
  currentMenuId?: string | null;
}

const { publication, currentMenuId } = Astro.props;

const navItems = publication.preferences?.navbarItems ?? [];
// Always show dark mode toggle â€” the publication setting only controls the default theme
const hasDarkMode = true;
---

<header class="sticky top-0 z-40 border-b border-slate-200/80 bg-white/80 backdrop-blur-lg dark:border-slate-800/80 dark:bg-neutral-950/80">
  <Container class="flex h-16 items-center justify-between">
    <!-- Logo -->
    <PublicationLogo publication={publication} size="lg" />

    <!-- Desktop Nav -->
    <nav class="hidden items-center gap-1 md:flex" aria-label="Main navigation">
      {navItems.map((item) => (
        <a
          href={item.url}
          class:list={[
            'rounded-md px-3 py-2 text-sm font-medium transition-colors hover:bg-slate-100 dark:hover:bg-slate-800',
            currentMenuId === item.id
              ? 'text-blue-600 dark:text-blue-400'
              : 'text-slate-700 dark:text-slate-300',
          ]}
        >
          {item.label}
        </a>
      ))}
    </nav>

    <!-- Right actions -->
    <div class="flex items-center gap-2">
      <!-- Search button -->
      <button
        type="button"
        id="search-btn"
        class="rounded-full p-2 text-slate-600 transition-colors hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-800"
        aria-label="Search"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8" />
          <path d="m21 21-4.3-4.3" />
        </svg>
      </button>

      <!-- Dark mode toggle -->
      {hasDarkMode && (
        <button
          type="button"
          id="theme-toggle"
          class="rounded-full p-2 text-slate-600 transition-colors hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-800"
          aria-label="Toggle dark mode"
        >
          <!-- Sun icon (shown in dark mode) -->
          <svg class="hidden h-5 w-5 dark:block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="4" />
            <path d="M12 2v2" />
            <path d="M12 20v2" />
            <path d="m4.93 4.93 1.41 1.41" />
            <path d="m17.66 17.66 1.41 1.41" />
            <path d="M2 12h2" />
            <path d="M20 12h2" />
            <path d="m6.34 17.66-1.41 1.41" />
            <path d="m19.07 4.93-1.41 1.41" />
          </svg>
          <!-- Moon icon (shown in light mode) -->
          <svg class="block h-5 w-5 dark:hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" />
          </svg>
        </button>
      )}

      <!-- Mobile menu toggle -->
      <button
        type="button"
        id="mobile-menu-btn"
        class="rounded-full p-2 text-slate-600 transition-colors hover:bg-slate-100 md:hidden dark:text-slate-400 dark:hover:bg-slate-800"
        aria-label="Open menu"
        aria-expanded="false"
        aria-controls="mobile-menu"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="4" x2="20" y1="12" y2="12" />
          <line x1="4" x2="20" y1="6" y2="6" />
          <line x1="4" x2="20" y1="18" y2="18" />
        </svg>
      </button>
    </div>
  </Container>

  <!-- Mobile menu overlay -->
  <div
    id="mobile-menu"
    class="fixed inset-0 z-50 hidden"
    role="dialog"
    aria-modal="true"
    aria-label="Navigation menu"
  >
    <!-- Backdrop -->
    <div id="mobile-menu-backdrop" class="fixed inset-0 bg-black/50 backdrop-blur-sm"></div>

    <!-- Sidebar -->
    <nav class="fixed inset-y-0 left-0 w-72 overflow-y-auto bg-white p-6 shadow-xl dark:bg-slate-900">
      <div class="mb-8 flex items-center justify-between">
        <PublicationLogo publication={publication} size="sm" />
        <button
          type="button"
          id="mobile-menu-close"
          class="rounded-full p-2 text-slate-600 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-800"
          aria-label="Close menu"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 6 6 18" />
            <path d="m6 6 12 12" />
          </svg>
        </button>
      </div>

      <ul class="space-y-1">
        {navItems.map((item) => (
          <li>
            <a
              href={item.url}
              class:list={[
                'block rounded-md px-3 py-2.5 text-sm font-medium transition-colors hover:bg-slate-100 dark:hover:bg-slate-800',
                currentMenuId === item.id
                  ? 'bg-slate-100 text-blue-600 dark:bg-slate-800 dark:text-blue-400'
                  : 'text-slate-700 dark:text-slate-300',
              ]}
            >
              {item.label}
            </a>
          </li>
        ))}
      </ul>
    </nav>
  </div>
</header>

<!-- Header client-side scripts (dark mode toggle + mobile menu) -->
<script>
  // Dark mode toggle
  const themeToggle = document.getElementById('theme-toggle');
  themeToggle?.addEventListener('click', () => {
    const isDark = document.documentElement.classList.toggle('dark');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
  });

  // Mobile menu
  const mobileMenuBtn = document.getElementById('mobile-menu-btn');
  const mobileMenu = document.getElementById('mobile-menu');
  const mobileMenuClose = document.getElementById('mobile-menu-close');
  const mobileMenuBackdrop = document.getElementById('mobile-menu-backdrop');

  function openMobileMenu() {
    mobileMenu?.classList.remove('hidden');
    mobileMenuBtn?.setAttribute('aria-expanded', 'true');
    document.body.style.overflow = 'hidden';
  }

  function closeMobileMenu() {
    mobileMenu?.classList.add('hidden');
    mobileMenuBtn?.setAttribute('aria-expanded', 'false');
    document.body.style.overflow = '';
  }

  mobileMenuBtn?.addEventListener('click', openMobileMenu);
  mobileMenuClose?.addEventListener('click', closeMobileMenu);
  mobileMenuBackdrop?.addEventListener('click', closeMobileMenu);

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !mobileMenu?.classList.contains('hidden')) {
      closeMobileMenu();
    }
  });
</script>
