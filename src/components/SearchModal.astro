---
interface Props {
  publicationId: string;
}

import { SITE_LANG } from '../lib/client';

const { publicationId } = Astro.props;
const gqlEndpoint = import.meta.env.PUBLIC_HASHNODE_GQL_ENDPOINT || 'https://gql.hashnode.com';
const siteLang = SITE_LANG;
---

<!-- Search Modal -->
<div
  id="search-modal"
  class="fixed inset-0 z-50 hidden"
  role="dialog"
  aria-modal="true"
  aria-label="Search posts"
  data-publication-id={publicationId}
  data-gql-endpoint={gqlEndpoint}
  data-site-lang={siteLang}
>
  <!-- Backdrop -->
  <div id="search-backdrop" class="fixed inset-0 bg-black/60 backdrop-blur-sm"></div>

  <!-- Modal -->
  <div class="fixed inset-x-0 top-[10vh] mx-auto max-w-2xl px-4">
    <div class="overflow-hidden rounded-xl border border-slate-200 bg-white shadow-2xl dark:border-slate-700 dark:bg-slate-900">
      <!-- Search input -->
      <div class="flex items-center border-b border-slate-200 dark:border-slate-700">
        <svg class="ml-4 h-5 w-5 flex-shrink-0 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8" />
          <path d="m21 21-4.3-4.3" />
        </svg>
        <input
          id="search-input"
          type="text"
          placeholder="Search posts..."
          autocomplete="off"
          class="w-full bg-transparent px-4 py-4 text-slate-900 placeholder-slate-400 outline-none dark:text-slate-100"
        />
        <kbd class="mr-4 hidden rounded border border-slate-300 px-1.5 py-0.5 text-xs text-slate-400 dark:border-slate-600 sm:inline">
          ESC
        </kbd>
      </div>

      <!-- Results -->
      <div id="search-results" class="max-h-[60vh] overflow-y-auto">
        <!-- Initial state -->
        <div id="search-empty" class="px-6 py-12 text-center text-sm text-slate-500">
          Type to search posts...
        </div>

        <!-- Loading state -->
        <div id="search-loading" class="hidden px-6 py-12 text-center text-sm text-slate-500">
          <svg class="mx-auto mb-2 h-6 w-6 animate-spin text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
          </svg>
          Searching...
        </div>

        <!-- No results state -->
        <div id="search-no-results" class="hidden px-6 py-12 text-center text-sm text-slate-500">
          No posts found. Try a different search term.
        </div>

        <!-- Results list -->
        <ul id="search-list" class="hidden divide-y divide-slate-100 dark:divide-slate-800"></ul>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('astro:page-load', () => {
    const modal = document.getElementById('search-modal') as HTMLElement | null;
    if (!modal) return;

    const backdrop = document.getElementById('search-backdrop');
    const input = document.getElementById('search-input') as HTMLInputElement | null;
    const searchBtn = document.getElementById('search-btn');
    const emptyState = document.getElementById('search-empty');
    const loadingState = document.getElementById('search-loading');
    const noResultsState = document.getElementById('search-no-results');
    const resultsList = document.getElementById('search-list');

    const publicationId = modal.dataset.publicationId || '';
    const gqlEndpoint = modal.dataset.gqlEndpoint || 'https://gql.hashnode.com';
    const siteLang = modal.dataset.siteLang || 'en';

    let debounceTimer: ReturnType<typeof setTimeout> | undefined;
    let searchAbort: AbortController | null = null;

    function openSearch() {
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      setTimeout(() => input?.focus(), 50);
    }

    function closeSearch() {
      modal.classList.add('hidden');
      document.body.style.overflow = '';
      clearTimeout(debounceTimer);
      if (searchAbort) { searchAbort.abort(); searchAbort = null; }
      if (input) input.value = '';
      showState('empty');
    }

    function showState(state: string) {
      emptyState?.classList.toggle('hidden', state !== 'empty');
      loadingState?.classList.toggle('hidden', state !== 'loading');
      noResultsState?.classList.toggle('hidden', state !== 'no-results');
      resultsList?.classList.toggle('hidden', state !== 'results');
    }

    function createResultItem(node: any) {
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.href = '/' + node.slug;
      a.className = 'flex gap-4 px-6 py-4 transition-colors hover:bg-slate-50 dark:hover:bg-slate-800/50';

      const textDiv = document.createElement('div');
      textDiv.className = 'min-w-0 flex-1';

      const h3 = document.createElement('h3');
      h3.className = 'font-medium text-slate-900 dark:text-slate-100 line-clamp-1';
      h3.textContent = node.title;

      const brief = document.createElement('p');
      brief.className = 'mt-1 text-sm text-slate-500 line-clamp-2';
      brief.textContent = node.brief || '';

      const date = new Date(node.publishedAt).toLocaleDateString(siteLang, {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
      });
      const meta = document.createElement('p');
      meta.className = 'mt-1.5 text-xs text-slate-400';
      meta.textContent = (node.author?.name || '') + ' \u00B7 ' + date;

      textDiv.appendChild(h3);
      textDiv.appendChild(brief);
      textDiv.appendChild(meta);
      a.appendChild(textDiv);

      if (node.coverImage?.url) {
        const img = document.createElement('img');
        img.src = node.coverImage.url;
        img.alt = '';
        img.loading = 'lazy';
        img.className = 'hidden h-16 w-24 flex-shrink-0 rounded-lg object-cover sm:block';
        a.appendChild(img);
      }

      li.appendChild(a);
      return li;
    }

    async function performSearch(query: string) {
      if (!query || query.length < 2) {
        showState('empty');
        return;
      }

      showState('loading');

      if (searchAbort) searchAbort.abort();
      searchAbort = new AbortController();

      try {
        const res = await fetch(gqlEndpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          signal: searchAbort.signal,
          body: JSON.stringify({
            query: `query SearchPosts($first: Int!, $filter: SearchPostsOfPublicationFilter!) {
              searchPostsOfPublication(first: $first, filter: $filter) {
                edges {
                  node {
                    title
                    brief
                    slug
                    publishedAt
                    coverImage { url }
                    author { name }
                  }
                }
              }
            }`,
            variables: {
              first: 10,
              filter: { query, publicationId },
            },
          }),
        });

        const data = await res.json();
        const edges = data?.data?.searchPostsOfPublication?.edges ?? [];

        if (edges.length === 0) {
          showState('no-results');
          return;
        }

        // Clear previous results safely
        while (resultsList?.firstChild) {
          resultsList.removeChild(resultsList.firstChild);
        }

        for (const { node } of edges) {
          resultsList?.appendChild(createResultItem(node));
        }

        showState('results');
      } catch (err) {
        if (err instanceof DOMException && err.name === 'AbortError') return;
        console.error('Search error:', err);
        showState('no-results');
      }
    }

    // Event listeners
    searchBtn?.addEventListener('click', openSearch);
    backdrop?.addEventListener('click', closeSearch);

    document.addEventListener('keydown', (e) => {
      // Cmd/Ctrl+K to open search
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        if (modal.classList.contains('hidden')) {
          openSearch();
        } else {
          closeSearch();
        }
      }
      // ESC to close
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
        closeSearch();
      }
    });

    input?.addEventListener('input', (e) => {
      clearTimeout(debounceTimer);
      const query = (e.target as HTMLInputElement).value.trim();
      debounceTimer = setTimeout(() => performSearch(query), 300);
    });
  });
</script>
