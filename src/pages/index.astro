---
import BaseLayout from '../layouts/BaseLayout.astro';
import Container from '../components/Container.astro';
import PostCard from '../components/PostCard.astro';
import Pagination from '../components/Pagination.astro';
import { getHomePageInitial, getHomePagePosts } from '../lib/api';
import { SITE_LANG } from '../lib/client';

const POSTS_PER_PAGE = 9;

const { publication } = await getHomePageInitial();
const { publication: postsData } = await getHomePagePosts(POSTS_PER_PAGE);
const posts = postsData.posts.edges.map((e) => e.node);

// If no pinned post, use the latest post as hero
const heroPost = publication.pinnedPost ?? posts[0] ?? null;
const isPinned = !!publication.pinnedPost;
const listPosts = heroPost ? posts.filter((p) => p.id !== heroPost.id) : posts;

const totalPosts = postsData.posts.totalDocuments ?? posts.length;
const totalPages = Math.ceil(totalPosts / POSTS_PER_PAGE);

const siteTitle = publication.displayTitle || publication.title;
---

<BaseLayout
  title={siteTitle}
  description={publication.descriptionSEO}
  publication={publication}
  pageType="home"
  lcpImage={heroPost?.coverImage?.url}
>
  <Container class="py-12">
    {/* Hero / Pinned or Latest Post */}
    {heroPost && (
      <section class="mb-12 overflow-hidden rounded-2xl border border-slate-200 bg-slate-50 dark:border-slate-800 dark:bg-slate-900">
        {heroPost.coverImage?.url && (
          <a href={`/${heroPost.slug}`}>
            <img
              src={heroPost.coverImage.url}
              alt={heroPost.title}
              class="aspect-[2.5/1] w-full object-cover"
              fetchpriority="high"
              width="1200"
              height="480"
              decoding="async"
            />
          </a>
        )}
        <div class="p-6 sm:p-8">
          <span class="text-xs font-semibold uppercase tracking-wide text-blue-600 dark:text-blue-400">
            {isPinned ? 'Pinned' : 'Latest'}
          </span>
          <h2 class="mt-2 font-heading text-2xl font-bold sm:text-3xl">
            <a href={`/${heroPost.slug}`} class="hover:text-blue-600 dark:hover:text-blue-400">
              {heroPost.title}
            </a>
          </h2>
          {heroPost.brief && (
            <p class="mt-3 text-slate-600 dark:text-slate-400 line-clamp-3">
              {heroPost.brief}
            </p>
          )}
          <div class="mt-4 flex items-center gap-3 text-sm text-slate-500">
            {heroPost.author.profilePicture && (
              <img
                src={heroPost.author.profilePicture}
                alt={heroPost.author.name}
                class="h-8 w-8 rounded-full"
                width="32"
                height="32"
                loading="lazy"
                decoding="async"
              />
            )}
            <span class="font-medium text-slate-700 dark:text-slate-300">{heroPost.author.name}</span>
            <span>&middot;</span>
            <time datetime={heroPost.publishedAt}>
              {new Date(heroPost.publishedAt).toLocaleDateString(SITE_LANG)}
            </time>
            {heroPost.readTimeInMinutes && (
              <>
                <span>&middot;</span>
                <span>{heroPost.readTimeInMinutes} min read</span>
              </>
            )}
          </div>
        </div>
      </section>
    )}

    {/* Posts Grid */}
    <section>
      <h2 class="mb-8 font-heading text-2xl font-bold">Recent Posts</h2>
      <div class="grid gap-8 sm:grid-cols-2 lg:grid-cols-3">
        {listPosts.map((post) => (
          <PostCard post={post} />
        ))}
      </div>

      <Pagination currentPage={1} totalPages={totalPages} />
    </section>
  </Container>
</BaseLayout>
