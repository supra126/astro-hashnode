---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Container from '../../components/Container.astro';
import PostCard from '../../components/PostCard.astro';
import Pagination from '../../components/Pagination.astro';
import { getHomePageInitial, getHomePagePosts } from '../../lib/api';
import { PINNED_POST_IN_LIST } from '../../lib/client';
import type { GetStaticPaths } from 'astro';

export const getStaticPaths: GetStaticPaths = async () => {
  const POSTS_PER_PAGE = 9;
  const { publication } = await getHomePageInitial();
  const { publication: postsData } = await getHomePagePosts(1);
  const shouldFilter = !PINNED_POST_IN_LIST && !!publication.pinnedPost;
  const totalPosts = (postsData.posts.totalDocuments ?? 0) - (shouldFilter ? 1 : 0);
  const totalPages = Math.ceil(totalPosts / POSTS_PER_PAGE);

  // Generate pages 2..N (page 1 is handled by index.astro)
  const paths = [];
  let cursor: string | undefined;

  // Walk through pages 1..(N-1), fetching cursors to build paths for pages 2..N
  for (let page = 1; page < totalPages; page++) {
    const { publication: data } = await getHomePagePosts(POSTS_PER_PAGE, cursor);
    cursor = data.posts.pageInfo.endCursor ?? undefined;

    paths.push({
      params: { page: String(page + 1) },
      props: { pageNum: page + 1, after: cursor, totalPages },
    });
  }

  return paths;
};

const POSTS_PER_PAGE = 9;
const { pageNum, after, totalPages } = Astro.props;

const { publication } = await getHomePageInitial();
const { publication: postsData } = await getHomePagePosts(POSTS_PER_PAGE, after);
const pinnedPostId = !PINNED_POST_IN_LIST ? publication.pinnedPost?.id : undefined;
const posts = postsData.posts.edges
  .map((e) => e.node)
  .filter((post) => !pinnedPostId || post.id !== pinnedPostId);

const siteTitle = publication.displayTitle || publication.title;
---

<BaseLayout
  title={`${siteTitle} - Page ${pageNum}`}
  description={publication.descriptionSEO}
  publication={publication}
  pageType="home"
>
  <Container class="py-12">
    <section>
      <h2 class="mb-8 font-heading text-2xl font-bold">Posts - Page {pageNum}</h2>
      <div class="grid gap-8 sm:grid-cols-2 lg:grid-cols-3">
        {posts.map((post) => (
          <PostCard post={post} />
        ))}
      </div>

      <Pagination currentPage={pageNum} totalPages={totalPages} />
    </section>
  </Container>
</BaseLayout>
